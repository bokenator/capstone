<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Equity Chart (React + Lightweight Charts)</title>
    <style>
      :root {
        --bg: #0b1220;
        --panel: #0f172a;
        --border: #1f2937;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --accent: #22c55e;
        --red: #ef4444;
        --blue: #3b82f6;
        --purple: #a855f7;
        --orange: #f97316;
        --cyan: #06b6d4;
      }
      body {
        margin: 0;
        padding: 20px;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .wrap {
        max-width: 960px;
        margin: 0 auto;
      }
      .card {
        background: linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
      }
      .header {
        display: flex;
        align-items: baseline;
        gap: 10px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .title {
        font-size: 20px;
        font-weight: 700;
      }
      .badge {
        background: rgba(34, 197, 94, 0.15);
        color: var(--accent);
        border: 1px solid rgba(34, 197, 94, 0.35);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 600;
      }
      .badge.red {
        background: rgba(239, 68, 68, 0.15);
        color: var(--red);
        border-color: rgba(239, 68, 68, 0.35);
      }
      #chart {
        width: 100%;
        height: 420px;
      }
      .legend {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-top: 12px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
      }
      .legend-color {
        width: 12px;
        height: 3px;
        border-radius: 2px;
      }
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }
      .metric-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
      }
      .metric-label {
        color: var(--muted);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }
      .metric-value {
        font-size: 18px;
        font-weight: 600;
      }
      .metric-value.positive {
        color: var(--accent);
      }
      .metric-value.negative {
        color: var(--red);
      }
      .symbol-metrics {
        margin-top: 16px;
      }
      .symbol-metrics h4 {
        margin: 0 0 8px 0;
        font-size: 14px;
        color: var(--muted);
      }
      .symbol-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        margin-bottom: 6px;
      }
      .symbol-name {
        font-weight: 600;
        min-width: 60px;
      }
      .symbol-stat {
        font-size: 13px;
        color: var(--muted);
      }
      .symbol-stat strong {
        color: var(--text);
      }
      .meta {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: 13px;
        margin-top: 10px;
      }
      .meta strong {
        color: var(--text);
      }
      .notice {
        margin-top: 12px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--muted);
        font-size: 13px;
      }
      .empty {
        color: #f87171;
        margin-top: 8px;
      }
      .rows {
        font-family: monospace;
        white-space: pre-wrap;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
      .params-section {
        margin-top: 16px;
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
      }
      .params-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.03);
        cursor: pointer;
        user-select: none;
      }
      .params-header:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      .params-header h4 {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .params-toggle {
        font-size: 12px;
        color: var(--muted);
      }
      .params-content {
        padding: 14px;
        background: rgba(0, 0, 0, 0.2);
      }
      .params-group {
        margin-bottom: 14px;
      }
      .params-group:last-child {
        margin-bottom: 0;
      }
      .params-group-title {
        font-size: 11px;
        color: var(--accent);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 1px solid var(--border);
      }
      .params-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 8px;
      }
      .param-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 10px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 6px;
        font-size: 12px;
      }
      .param-key {
        color: var(--muted);
      }
      .param-value {
        color: var(--text);
        font-family: monospace;
        font-weight: 500;
      }
      .param-value.null {
        color: var(--muted);
        font-style: italic;
      }
      .code-block {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        font-family: monospace;
        font-size: 11px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 200px;
        overflow-y: auto;
        color: var(--text);
      }
      .prompt-text {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 12px;
        line-height: 1.5;
        color: var(--text);
        font-style: italic;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script>
      const { useEffect, useRef, useState, useSyncExternalStore } = React;
      const SET_GLOBALS_EVENT_TYPE = "openai:set_globals";

      const COLORS = ["#22c55e", "#3b82f6", "#a855f7", "#f97316", "#06b6d4", "#ec4899"];

      function useOpenAiGlobal(key) {
        return useSyncExternalStore(
          (onChange) => {
            const handler = (event) => {
              if (event.detail?.globals?.hasOwnProperty(key)) {
                onChange();
              }
            };
            window.addEventListener(SET_GLOBALS_EVENT_TYPE, handler, { passive: true });
            return () => window.removeEventListener(SET_GLOBALS_EVENT_TYPE, handler);
          },
          () => (window.openai ? window.openai[key] ?? null : null),
          () => null
        );
      }

      function parseQueryPayload() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get("structuredContent") || params.get("data");
        if (!raw) return null;
        try {
          return JSON.parse(decodeURIComponent(raw));
        } catch (e) {
          console.warn("[equity-chart] failed to parse query payload", e);
          return null;
        }
      }

      function normalizePayload(raw) {
        if (!raw) return null;

        // Check for multi-symbol equity_curves
        if (raw.equity_curves && Object.keys(raw.equity_curves).length > 0) {
          const curves = {};
          for (const [symbol, data] of Object.entries(raw.equity_curves)) {
            curves[symbol] = data.map((d) => ({
              time: Math.floor(new Date(d.timestamp).getTime() / 1000),
              value: Number(d.value),
            }));
          }
          return { ...raw, multiCurves: curves };
        }

        // Fallback to single curve from data array
        if (!Array.isArray(raw.data)) return null;
        const lineData = raw.data.map((d) => ({
          time: Math.floor(new Date(d.timestamp).getTime() / 1000),
          value: Number(d.close),
        }));
        return { ...raw, lineData };
      }

      function formatPercent(val) {
        if (val == null || isNaN(val)) return "â€”";
        return (val * 100).toFixed(2) + "%";
      }

      function formatNumber(val, decimals = 2) {
        if (val == null || isNaN(val)) return "â€”";
        return Number(val).toFixed(decimals);
      }

      function formatParamValue(val) {
        if (val === null || val === undefined) return "null";
        if (typeof val === "boolean") return val ? "true" : "false";
        if (typeof val === "number") return val.toString();
        if (typeof val === "string") return val;
        if (Array.isArray(val)) return JSON.stringify(val);
        if (typeof val === "object") return JSON.stringify(val);
        return String(val);
      }

      function ParamsSection({ payload }) {
        const [expanded, setExpanded] = useState(false);

        if (!payload) return null;

        const params = payload.params || {};
        const paramSchema = payload.param_schema || {};
        const dataSchema = payload.data_schema || {};
        const prompt = payload.prompt || "";
        const generatedCode = payload.generated_code || "";

        // Execution parameters
        const execParams = {
          direction: payload.direction,
          execution_price: payload.execution_price,
          stop_loss: payload.stop_loss,
          take_profit: payload.take_profit,
          trailing_stop: payload.trailing_stop,
          slippage: payload.slippage,
        };

        // Strategy-specific parameters (exclude built-in execution params)
        const builtinKeys = ['execution_frequency', 'execution_price', 'direction', 'stop_loss', 'take_profit', 'trailing_stop', 'slippage'];
        const strategyParams = {};
        for (const [k, v] of Object.entries(params)) {
          if (!builtinKeys.includes(k)) {
            strategyParams[k] = v;
          }
        }

        return React.createElement(
          "div",
          { className: "params-section" },
          React.createElement(
            "div",
            { className: "params-header", onClick: () => setExpanded(!expanded) },
            React.createElement("h4", null, "ðŸ“‹ Parameters for Reproducibility"),
            React.createElement("span", { className: "params-toggle" }, expanded ? "â–¼ Hide" : "â–¶ Show")
          ),
          expanded && React.createElement(
            "div",
            { className: "params-content" },

            // Prompt
            prompt && React.createElement(
              "div",
              { className: "params-group" },
              React.createElement("div", { className: "params-group-title" }, "Strategy Prompt"),
              React.createElement("div", { className: "prompt-text" }, prompt)
            ),

            // Execution Parameters
            React.createElement(
              "div",
              { className: "params-group" },
              React.createElement("div", { className: "params-group-title" }, "Execution Parameters"),
              React.createElement(
                "div",
                { className: "params-grid" },
                Object.entries(execParams).map(([key, val]) =>
                  React.createElement(
                    "div",
                    { className: "param-item", key: key },
                    React.createElement("span", { className: "param-key" }, key),
                    React.createElement(
                      "span",
                      { className: "param-value" + (val === null || val === undefined ? " null" : "") },
                      formatParamValue(val)
                    )
                  )
                )
              )
            ),

            // Strategy Parameters
            Object.keys(strategyParams).length > 0 && React.createElement(
              "div",
              { className: "params-group" },
              React.createElement("div", { className: "params-group-title" }, "Strategy Parameters"),
              React.createElement(
                "div",
                { className: "params-grid" },
                Object.entries(strategyParams).map(([key, val]) => {
                  const schema = paramSchema[key] || {};
                  const desc = schema.description ? ` (${schema.description})` : "";
                  return React.createElement(
                    "div",
                    { className: "param-item", key: key, title: desc },
                    React.createElement("span", { className: "param-key" }, key),
                    React.createElement(
                      "span",
                      { className: "param-value" + (val === null || val === undefined ? " null" : "") },
                      formatParamValue(val)
                    )
                  );
                })
              )
            ),

            // Data Schema
            Object.keys(dataSchema).length > 0 && React.createElement(
              "div",
              { className: "params-group" },
              React.createElement("div", { className: "params-group-title" }, "Data Schema"),
              React.createElement(
                "div",
                { className: "params-grid" },
                Object.entries(dataSchema).map(([slot, config]) =>
                  React.createElement(
                    "div",
                    { className: "param-item", key: slot, style: { gridColumn: "span 2" } },
                    React.createElement("span", { className: "param-key" }, slot),
                    React.createElement(
                      "span",
                      { className: "param-value" },
                      `${config.frequency || "?"} | ${(config.columns || []).join(", ")}`
                    )
                  )
                )
              )
            ),

            // Symbol Mapping
            payload.symbol_mapping && React.createElement(
              "div",
              { className: "params-group" },
              React.createElement("div", { className: "params-group-title" }, "Symbol Mapping"),
              React.createElement(
                "div",
                { className: "params-grid" },
                Object.entries(payload.symbol_mapping).map(([slot, symbol]) =>
                  React.createElement(
                    "div",
                    { className: "param-item", key: slot },
                    React.createElement("span", { className: "param-key" }, slot),
                    React.createElement("span", { className: "param-value" }, symbol)
                  )
                )
              )
            ),

            // Generated Code
            generatedCode && React.createElement(
              "div",
              { className: "params-group" },
              React.createElement("div", { className: "params-group-title" }, "Generated Strategy Code"),
              React.createElement("pre", { className: "code-block" }, generatedCode)
            )
          )
        );
      }

      function App() {
        const toolOutput = useOpenAiGlobal("toolOutput");
        const toolResponseMetadata = useOpenAiGlobal("toolResponseMetadata");
        const chartRef = useRef(null);
        const chartApiRef = useRef(null);
        const seriesRefs = useRef({});
        const [state, setState] = useState(() => {
          const candidate = toolOutput ?? parseQueryPayload();
          return {
            normalizedPayload: normalizePayload(candidate),
            source: candidate ? (toolOutput ? "toolOutput" : "query") : "none",
          };
        });

        useEffect(() => {
          const candidate = toolOutput ?? parseQueryPayload();
          setState({
            normalizedPayload: normalizePayload(candidate),
            source: candidate ? (toolOutput ? "toolOutput" : "query") : "none",
          });
        }, [toolOutput]);

        useEffect(() => {
          const container = chartRef.current;
          if (!container || chartApiRef.current) return;
          const LW = window.LightweightCharts;
          const chart = LW.createChart(container, {
            layout: { background: { color: "#0b1220" }, textColor: "#e2e8f0" },
            grid: { vertLines: { color: "#1f2937" }, horzLines: { color: "#1f2937" } },
            crosshair: { mode: LW.CrosshairMode.Normal },
            timeScale: { borderColor: "#1f2937" },
            rightPriceScale: { borderColor: "#1f2937" },
          });
          chartApiRef.current = chart;
        }, []);

        useEffect(() => {
          if (!state.normalizedPayload || !chartApiRef.current) return;

          const chart = chartApiRef.current;
          const payload = state.normalizedPayload;

          // Clear existing series
          Object.values(seriesRefs.current).forEach((s) => {
            try { chart.removeSeries(s); } catch (e) {}
          });
          seriesRefs.current = {};

          // Multi-curve mode
          if (payload.multiCurves) {
            const symbols = Object.keys(payload.multiCurves);
            symbols.forEach((symbol, i) => {
              const color = COLORS[i % COLORS.length];
              const series = chart.addLineSeries({
                color,
                lineWidth: 2,
                crosshairMarkerVisible: true,
                crosshairMarkerRadius: 4,
                title: symbol,
              });
              series.setData(payload.multiCurves[symbol]);
              seriesRefs.current[symbol] = series;
            });
          } else if (payload.lineData) {
            // Single curve fallback
            const series = chart.addLineSeries({
              color: "#22c55e",
              lineWidth: 2,
              crosshairMarkerVisible: true,
              crosshairMarkerRadius: 4,
            });
            series.setData(payload.lineData);
            seriesRefs.current["main"] = series;
          }

          chart.timeScale().fitContent();
        }, [state]);

        const payload = state.normalizedPayload;
        const metrics = payload?.metrics || {};
        const metricsBySymbol = payload?.metrics_by_symbol || {};
        const symbols = payload?.symbols || [];
        const hasMultiCurves = payload?.multiCurves && Object.keys(payload.multiCurves).length > 0;

        const rows = payload && payload.data ? payload.data.slice(0, 10) : [];
        const dateRange =
          payload && payload.data && payload.data.length > 1
            ? `${new Date(payload.data[0].timestamp).toISOString().slice(0, 10)} â†’ ${new Date(
                payload.data[payload.data.length - 1].timestamp
              )
                .toISOString()
                .slice(0, 10)}`
            : "n/a";

        const totalReturn = metrics.total_return || 0;
        const isPositive = totalReturn >= 0;

        const logDebug = () => {
          console.log("[equity-chart] debug", {
            toolOutput,
            toolResponseMetadata,
            source: state.source,
            payload: state.normalizedPayload,
          });
        };

        return React.createElement(
          "div",
          { className: "wrap" },
          React.createElement(
            "div",
            { className: "card" },
            React.createElement(
              "div",
              { className: "header" },
              React.createElement("div", { className: "title" }, payload?.symbol || "Equity Chart"),
              React.createElement("span", { className: "badge" }, payload?.timeframe || "â€”")
            ),
            React.createElement("div", { id: "chart", ref: chartRef }),

            // Legend for multi-curve
            hasMultiCurves && React.createElement(
              "div",
              { className: "legend" },
              symbols.map((symbol, i) =>
                React.createElement(
                  "div",
                  { className: "legend-item", key: symbol },
                  React.createElement("div", {
                    className: "legend-color",
                    style: { backgroundColor: COLORS[i % COLORS.length] }
                  }),
                  React.createElement("span", null, symbol)
                )
              )
            ),

            payload
              ? React.createElement(
                  React.Fragment,
                  null,

                  // Per-symbol metrics
                  hasMultiCurves && Object.keys(metricsBySymbol).length > 0 && React.createElement(
                    "div",
                    { className: "symbol-metrics" },
                    React.createElement("h4", null, "Performance by Symbol"),
                    symbols.map((symbol, i) => {
                      const m = metricsBySymbol[symbol] || {};
                      const ret = m.total_return || 0;
                      return React.createElement(
                        "div",
                        { className: "symbol-row", key: symbol },
                        React.createElement(
                          "div",
                          { className: "symbol-name", style: { color: COLORS[i % COLORS.length] } },
                          symbol
                        ),
                        React.createElement(
                          "div",
                          { className: "symbol-stat" },
                          React.createElement("strong", { style: { color: ret >= 0 ? "#22c55e" : "#ef4444" } }, formatPercent(ret)),
                          " return"
                        ),
                        React.createElement(
                          "div",
                          { className: "symbol-stat" },
                          React.createElement("strong", null, m.num_trades ?? "â€”"),
                          " trades"
                        ),
                        React.createElement(
                          "div",
                          { className: "symbol-stat" },
                          "Sharpe: ",
                          React.createElement("strong", null, formatNumber(m.sharpe_ratio))
                        ),
                        React.createElement(
                          "div",
                          { className: "symbol-stat" },
                          "MaxDD: ",
                          React.createElement("strong", { style: { color: "#ef4444" } }, formatPercent(m.max_drawdown))
                        )
                      );
                    })
                  ),

                  // Overall metrics grid (show first symbol or combined)
                  !hasMultiCurves && React.createElement(
                    "div",
                    { className: "metrics-grid" },
                    React.createElement(
                      "div",
                      { className: "metric-card" },
                      React.createElement("div", { className: "metric-label" }, "Entry Signals"),
                      React.createElement("div", { className: "metric-value" }, metrics.entry_signals ?? "â€”")
                    ),
                    React.createElement(
                      "div",
                      { className: "metric-card" },
                      React.createElement("div", { className: "metric-label" }, "Exit Signals"),
                      React.createElement("div", { className: "metric-value" }, metrics.exit_signals ?? "â€”")
                    ),
                    React.createElement(
                      "div",
                      { className: "metric-card" },
                      React.createElement("div", { className: "metric-label" }, "Trades"),
                      React.createElement("div", { className: "metric-value" }, metrics.num_trades ?? "â€”")
                    ),
                    React.createElement(
                      "div",
                      { className: "metric-card" },
                      React.createElement("div", { className: "metric-label" }, "Win Rate"),
                      React.createElement("div", { className: "metric-value" }, formatPercent(metrics.win_rate))
                    ),
                    React.createElement(
                      "div",
                      { className: "metric-card" },
                      React.createElement("div", { className: "metric-label" }, "Total Return"),
                      React.createElement(
                        "div",
                        { className: "metric-value " + (totalReturn >= 0 ? "positive" : "negative") },
                        formatPercent(totalReturn)
                      )
                    ),
                    React.createElement(
                      "div",
                      { className: "metric-card" },
                      React.createElement("div", { className: "metric-label" }, "Sharpe Ratio"),
                      React.createElement("div", { className: "metric-value" }, formatNumber(metrics.sharpe_ratio))
                    ),
                    React.createElement(
                      "div",
                      { className: "metric-card" },
                      React.createElement("div", { className: "metric-label" }, "Max Drawdown"),
                      React.createElement(
                        "div",
                        { className: "metric-value negative" },
                        formatPercent(metrics.max_drawdown)
                      )
                    ),
                    React.createElement(
                      "div",
                      { className: "metric-card" },
                      React.createElement("div", { className: "metric-label" }, "Profit Factor"),
                      React.createElement("div", { className: "metric-value" }, formatNumber(metrics.profit_factor))
                    )
                  ),

                  React.createElement(
                    "div",
                    { className: "meta" },
                    React.createElement("div", null, React.createElement("strong", null, "Symbols:"), " ", payload.symbol || symbols.join(", ")),
                    React.createElement("div", null, React.createElement("strong", null, "Timeframe:"), " ", payload.timeframe),
                    payload.data && React.createElement("div", null, React.createElement("strong", null, "Bars:"), " ", payload.data.length),
                    React.createElement("div", null, React.createElement("strong", null, "Range:"), " ", dateRange)
                  ),

                  // Parameters section for reproducibility
                  React.createElement(ParamsSection, { payload: payload })
                )
              : React.createElement("div", { className: "empty" }, "No data provided.")
          ),
          React.createElement(
            "div",
            { className: "notice" },
            React.createElement(
              "button",
              { onClick: logDebug, style: { padding: "8px 12px", borderRadius: "8px" } },
              "Print debug to console"
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
    </script>
  </body>
</html>
